# 메시지, 국제화

---

### 메시지

**상품명**이라는 단어를 모두 **상품이름**으로 변경해야 한다면 하드코딩 되어있기 때문에 단어를 찾아서 모두 변경해야한다.

다양한 메시지를 한 곳에서 관리하도록 하는 기능을 **메시지 기능**이라고 한다.

```text

item=상품
item.id=상품 ID
item.itemName=상품명
item.price=가격
item.quantity=수량

```

설정해 놓고 각 HTML들은 해당 데이터를 key값으로 불러서 사용할 수 있다.

`th:text=#{item.itemName}`

### 국제화

메시지에서 설명한 메시지 파일을 각 나라별로 관리하면서 서비스를 국제화 할 수 있다.

`accept-language`헤더 값을 사용하거나 사용자가 직접 언어를 선택하게 하고, 쿠키 등으로 처리할 수 있다.

메시지와 국제화 기능은 스프링이 기본적으로 모두 제공하고 타임리프도 스프링이 제공하는 메시지와 국제화 기능을 편리하게 통합해서 제공한다.

---


## 스프링 메시지 소스 설정

스프링은 기본적인 메시지 관리 기능을 제공한다.

관리 기능을 사용하려면 스프링이 제공하는 `MessageSource`를 스프링 빈으로 등록하면 되는데 이는 인터페이스이기 때문에 구현체인 `ResourceBundleMessageSource`를 스프링 빈으로 등력하면 된다.

### 직접 등록

```java
@SpringBootApplication
public class ItemServiceApplication {

    public static void main(String[] args) {
        SpringApplication.run(ItemServiceApplication.class, args);
    }


    @Bean
    public MessageSource messageSource() {
        ResourceBundleMessageSource messageSource = new ResourceBundleMessageSource();
        messageSource.setBasenames("messages", "errors");
        messageSource.setDefaultEncoding("utf-8");
        return messageSource;
    }
}
```

+ `setBasenames()`: 설정 파일 지정
  + `messages`로 지정하면 `messages.properties` 파일을 읽어서 사용한다.
  + 파일의 위치는 `/resources/messages.properties`에 두면 된다.
  + 여러 파일을 지정할 수 있다.
    + `messageSource.setDefaultEncoding("utf-8");` 

**스프링 부트**

스프링 부트를 사용하면 스프링 부트가 `MessageSource`를 자동으로 스프링 빈으로 등록한다.


**스프링 부트 메시지 소스 설정**

application.properties

`spring.messages.basename=messages,config.i18n.messages`

별도로 설정하지 않으면 default로 `spring.messages.basename=bessages`가 추가된다.


### 메시지 소스 파일 만들기

+ /resources/messages.properties

```text
hello=안녕
hello.name=안녕 {0}
```


+ /resources/messages_en.properties

```text
hello=hello
hello.name=hello {0}
```

---

## 스프링 메시지 사용

스프링 메시지 소스 테스트

```java
@SpringBootTest
public class MessageSourceTest {

  @Autowired
  MessageSource ms;

  @Test
  void helloMessage() {
    String result = ms.getMessage("hello", null, null);
    assertThat(result).isEqualTo("안녕");
  }
}
```

`getMessage()`
  + code: hello
  + args: null
  + locale: null

locale정보가 없으면 basename에서 설정한 기본 이름 메시지 파일을 조회한다.

스프링은 basename으로 `messages`를 지정하기 때문에 `messages.properties`에서 데이터를 조회한다.

```java
    @Test
    void notFoundMessageCode(){
        assertThatThrownBy(() -> ms.getMessage("no_code",null,null))
                .isInstanceOf(NoSuchMessageException.class);
    }
```

메시지가 없는 경우 `NoSuchMessageException`을 던진다.

```java
    @Test
    void notFoundMessageCodeDefaultMessage(){
        String result = ms.getMessage("no_code", null, "기본 메시지", null);
        assertThat(result).isEqualTo("기본 메시지");
    }
```

파라미터를 추가하면 메시지가 없는 경우 defaultMessage를 반환한다.

```java
    @Test
    void argumentMessage(){
        String result = ms.getMessage("hello.name", new Object[]{"Spring"}, null);
        assertThat(result).isEqualTo("안녕 Spring");
    }
```

매개변수가 있는 경우 치환해서 사용할 수 있다.

매개변수는 `Object[]`로 전달한다.

```java
    @Test
    void defaultLang(){
        assertThat(ms.getMessage("hello",null,null)).isEqualTo("안녕");
        assertThat(ms.getMessage("hello",null, Locale.KOREA)).isEqualTo("안녕");
    }

    @Test
    void enLang(){
        assertThat(ms.getMessage("hello",null,Locale.ENGLISH)).isEqualTo("hello");
    }
```

locale이 null이면 basename 사용하고 null이 아니면 지정한 Locale을 먼저 찾아보고 없으면 messages를 사용한다.

---

## 웹 애플리케이션에 메시지 적용하기

messages.properties 추가

```text
label.item=상품
label.item.id=상품 ID
label.item.itemName=상품명
label.item.price=가격
label.item.quantity=수량

page.items=상품 목록
page.item=상품 상세
page.addItem=상품 등록
page.updateItem=상품 수정

button.save=저장
button.cancel=취소
```

### 타임리프 메시지 적용

타임리프의 메시지 표현식은 `#{...}`을 사용한다.

상품이라는 이름을 조회하려면 `#{labe.item}`이라고 하면 된다.

html 파일에 `#{...}`으로 다 바꾸어 주면 된다.


파라미터는 다음과 같이 적용할 수 있다.

`hello.name=안녕 {0}`

`<p th:text=#{hello.name(${item.itemName})}"></p>`

---

## 웹 애플리케이션에 국제화 적용하기

---

messages_en.properties 추가

```text
label.item=Item
label.item.id=Item ID
label.item.itemName=Item Name
label.item.price=price
label.item.quantity=quantity

page.items=Item List
page.item=Item Detail
page.addItem=Item Add
page.updateItem=Item Update

button.save=Save
button.cancel=Cancel
```

이전에 템플릿 파일에 `#{...}`으로 메시지 작업을 끝냈기 때문에 국제화는 다른 설정을 할 필요가 없다.

웹 브라우저의 설정에 적용되어 있는 설정 값에 따라 `Accept-Language`의 값이 변경된다.

서버는 `Accept-Language`헤더의 값을 보고 Locale을 선택하여 보여준다.

### LocaleResolver

스프링은 `Locale` 선택 방식을 변경할 수 있도록 `LocaleResolver`라는 인터페이스를 제공한다.

스프링 부트는 기본으로 `Accept-Language`를 활용하는 `AcceptHeaderLocaleResolver`를 사용한다.


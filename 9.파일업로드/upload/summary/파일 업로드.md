# 파일 업로드

---

## 파일 업로드 소개

### HTML 폼 전송 방식

+ `appilcation/x-www-form-urlencoded`
+ `multipart/form-data`

`appilcation/x-www-form-urlencoded`은 HTML 폼 데이터를 서버로 전송하는 가장 기본적인 방식이다.

만약 이름, 나이, 첨부파일을 전송해야 하면 문자와 바이너리를 동시에 전송해야 하는 상황이 나온다.

HTTP 는 `multipart/form-data`라는 전송 방식을 제공한다.

이 방식을 사용하려면 `enctype="multipart/form-data"`를 지정해야 한다.

---

```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<ul>
    <li>상품 관리
        <ul>
            <li><a href="/servlet/v1/upload">서블릿 파일 업로드1</a></li>
            <li><a href="/servlet/v2/upload">서블릿 파일 업로드2</a></li>
            <li><a href="/spring/upload">스프링 파일 업로드</a></li>
            <li><a href="/items/new">상품 - 파일, 이미지 업로드</a></li>
        </ul>
    </li>
</ul>
</body>
</html>
```

---

## 서블릿과 파일 업로드1

---

```java
package hello.upload.controller;


import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.Part;
import java.io.IOException;
import java.util.Collection;

@Slf4j
@Controller
@RequestMapping("/servlet/v1")
public class ServletUploadControllerV1 {

    @GetMapping("/upload")
    public String newFile(){
        return "upload-form";
    }

    @PostMapping("/upload")
    public String saveFileV1(HttpServletRequest request) throws ServletException, IOException {
        log.info("request={}", request);

        String itemName = request.getParameter("itemName");
        log.info("itemName={}", itemName);

        Collection<Part> parts = request.getParts();
        log.info("parts={}",parts);

        return "upload-form";
    }

}
```

`request.getParts()`: multipart/form-data 전송 방식에서 각각 나누어진 부분을 받아서 확인할 수 있다.

application.properties에 다음을 추가한다.

`logging.level.org.apache.coyote.http11=debug`


```text
Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryfskJFL6W4zfZU0aF
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (HTML, like Gecko) Chrome/99.0.4844.74 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Sec-Fetch-Site: same-origin
Sec-Fetch-Mode: navigate
Sec-Fetch-User: ?1
Sec-Fetch-Dest: document
Referer: http://localhost:8080/servlet/v1/upload
Accept-Encoding: gzip, deflate, br
Accept-Language: ko,en-US;q=0.9,en;q=0.8,ko-KR;q=0.7

------WebKitFormBoundaryfskJFL6W4zfZU0aF
Content-Disposition: form-data; name="itemName"

Spring!
------WebKitFormBoundaryfskJFL6W4zfZU0aF
Content-Disposition: form-data; name="file"; filename="image.png"
Content-Type: image/png
```

`------WebKitFormBoundaryfskJFL6W4zfZU0aF` boundary에 따라 2개의 part로 나뉜것을 확인할 수 있다.



```text
request=org.springframework.web.multipart.support.StandardMultipartHttpServletRequest@2eecd1fc
itemName=Spring!         
parts=[org.apache.catalina.core.ApplicationPart@47c84cba, org.apache.catalina.core.ApplicationPart@7ff73291]
```

### spring.servlet.multipart.enabled 끄기

`spring.servlet.multipart.enabled=false`설정을 하면 서블릿 컨테이너는 멀티파트와 관련된 처리를 하지 않는다.

그 결과로 `request.getParameter("itemName")`, `request.getParts()`의 결과는 비어있게 된다.

이 옵션을 켜야 멀티파트 데이터를 처리할 수 있다.

---

## 서블릿과 파일 업로드2

업로드된 파일을 저장하기 위한 폴더가 필요하기 때문에 폴더를 생성해두고 경로를 설정한다.

application.properties

`file.dir=~~~/~~~/~~~/file/`

```java
@Slf4j
@Controller
@RequestMapping("/servlet/v2")
public class ServletUploadControllerV2 {

    @Value("${file.dir}")
    private String fileDir;

    @GetMapping("/upload")
    public String newFile(){
        return "upload-form";
    }

    @PostMapping("/upload")
    public String saveFileV1(HttpServletRequest request) throws ServletException, IOException {
        log.info("request={}", request);

        String itemName = request.getParameter("itemName");
        log.info("itemName={}", itemName);

        Collection<Part> parts = request.getParts();
        log.info("parts={}",parts);

        for (Part part : parts) {
            log.info("==== PART ====");
            log.info("name={}",part.getName());
            Collection<String> headerNames = part.getHeaderNames();
            for (String headerName : headerNames) {
                log.info("header {}: {}", headerName,part.getHeader(headerName));
            }

            //편의 메서드
            //content-disposition: filename
            log.info("submittedFilename={}", part.getSubmittedFileName());
            log.info("size={}",part.getSize());


            //데이터 읽기
            InputStream inputStream = part.getInputStream();
            String body = StreamUtils.copyToString(inputStream, StandardCharsets.UTF_8);
            log.info("body={}",body);

            //파일에 저장하기

            if(StringUtils.hasText(part.getSubmittedFileName())){
                String fullPath = fileDir + part.getSubmittedFileName();
                log.info("파일 저장 fullPath={}", fullPath);
                part.write(fullPath);
            }
        }

        return "upload-form";
    }

}
```


```text
 parts=[org.apache.catalina.core.ApplicationPart@67c345ac, org.apache.catalina.core.ApplicationPart@63fcdd8c]
 ==== PART ====                                                                                              
 name=itemName                                                                                               
 header content-disposition: form-data; name="itemName"                                                      
 submittedFilename=null                                                                                      
 size=6                                                                                                      
 body=SPRING                                                                                                 
 ==== PART ====                                                                                              
 name=file                                                                                                   
 header content-disposition: form-data; name="file"; filename="image.png"                                    
 header content-type: image/png                                                                              
 submittedFilename=image.png                                                                                 
 size=37257                                                                                                  
 body=�PNG                                                                                                   
```

---


## 스프링과 파일 업로드

스프링은 `MultiparFile`이라는 인터페이스로 멀티파트 파일을 매우 편리하게 지원한다.

---

```java
@Slf4j
@Controller
@RequestMapping("/spring")
public class SpringUploadController {

    @Value("${file.dir}")
    private String fileDir;

    @GetMapping("/upload")
    public String newFile(){
        return "upload-form";
    }

    @PostMapping("/upload")
    public String saveFile(@RequestParam String itemName,
                           @RequestParam MultipartFile file, HttpServletRequest request) throws IOException {

        log.info("request={}", request);
        log.info("itemName={}",itemName);
        log.info("multipartFile={}",file);

        if(!file.isEmpty()){
            String fullPath = fileDir + file.getOriginalFilename();
            log.info("파일 저장 fullPath={}",fullPath);

            file.transferTo(new File(fullPath));
        }

        return "upload-form";
    }
}
```

`@RequestParam`으로 form의 name에 맞추어 적용하면 된다.

`file.transferTo(...)`: 파일 저장

---

## 예제로 구현하는 파일 업로드, 다운로드

**요구사항**

+ 상품을 관리
  + 상품 이름
  + 첨부파일 하나
  + 이미지 파일 여러개
+ 첨부파일을 업로드 다운로드 할 수 있다.
+ 업로드한 이미지를 웹 브라우저에서 확인할 수 있다.

---

```java
@Data
public class Item {

    private Long id;
    private String itemName;
    private UploadFile attachFile;
    private List<UploadFile> imageFiles;

}
```

```java
@Repository
public class ItemRepository {

    private final Map<Long, Item> store = new HashMap<>();
    private long sequence = 0L;

    public Item save(Item item){
        item.setId(++sequence);
        store.put(item.getId(),item);
        return item;
    }

    public Item findById(Long id){
        return store.get(id);
    }
}
```

```java
@Data
public class UploadFile {

    private String uploadFileName;
    private String storeFileName;

    public UploadFile(String uploadFileName, String storeFileName) {
        this.uploadFileName = uploadFileName;
        this.storeFileName = storeFileName;
    }
}
```

업로드한 파일명은 서버 내부에 파일을 저장하면 안된다. 서로 다른 고객이 같은 파일 이름을 업로드하는 경우 기존 파일 이름과 충돌이 날 수 있다.

```java
@Component
public class FileStore {

    @Value("${file.dir}")
    private String fileDir;

    public String getFullPath(String filename){
        return fileDir + filename;
    }

    public List<UploadFile> storeFiles(List<MultipartFile> multipartFiles) throws IOException {
        List<UploadFile> storeFileResult = new ArrayList<>();

        for (MultipartFile multipartFile : multipartFiles) {
            if(!multipartFile.isEmpty()){
                storeFileResult.add(storeFile(multipartFile));

            }
        }

        return storeFileResult;
    }


    public UploadFile storeFile(MultipartFile multipartFile) throws IOException {
        if(multipartFile.isEmpty()){
            return null;
        }

        String originalFilename = multipartFile.getOriginalFilename();

        //서버에 저장하는 파일명
        String storeFileName = createStoreFileName(originalFilename);
        multipartFile.transferTo(new File(getFullPath(storeFileName)));

        return new UploadFile(originalFilename,storeFileName);
    }

    private String createStoreFileName(String originalFilename) {
        String uuid = UUID.randomUUID().toString();
        String ext = extractExt(originalFilename);
        return uuid + "." + ext;
    }

    private String extractExt(String originalFilename) {
        int pos = originalFilename.lastIndexOf(".");
        return  originalFilename.substring(pos + 1);
    }

}
```

```java
@Data
public class ItemForm {

    private Long itemId;
    private String itemName;
    private List<MultipartFile> imageFiles;
    private MultipartFile attachFile;
}
```

```java
@Slf4j
@Controller
@RequiredArgsConstructor
public class ItemController {

    private final ItemRepository itemRepository;
    private final FileStore fileStore;

    @GetMapping("/items/new")
    public String newItem(@ModelAttribute ItemForm form){
        return "item-form";
    }

    @PostMapping("items/new")
    public String saveItem(@ModelAttribute ItemForm form, RedirectAttributes redirectAttributes) throws IOException {
        UploadFile attachFile = fileStore.storeFile(form.getAttachFile());
        List<UploadFile> storeImageFiles = fileStore.storeFiles(form.getImageFiles());

        //데이터베이스에 저장
        Item item = new Item();
        item.setItemName(form.getItemName());
        item.setAttachFile(attachFile);
        item.setImageFiles(storeImageFiles);
        itemRepository.save(item);

        redirectAttributes.addAttribute("itemId",item.getId());

        return "redirect:/items/{itemId}";
    }

    @GetMapping("/items/{id}")
    public String items(@PathVariable Long id, Model model){
        Item item = itemRepository.findById(id);
        model.addAttribute("item",item);
        return "item-view";
    }

    @ResponseBody
    @GetMapping("/images/{filename}")
    public Resource downloadImage(@PathVariable String filename) throws MalformedURLException {
        return new UrlResource("file:" + fileStore.getFullPath(filename));
    }
    @GetMapping("/attach/{itemId}")
    public ResponseEntity<Resource> downloadAttach(@PathVariable Long itemId) throws MalformedURLException {
        Item item = itemRepository.findById(itemId);
        String storeFileName = item.getAttachFile().getStoreFileName();
        String uploadFileName = item.getAttachFile().getUploadFileName();

        UrlResource resource = new UrlResource("file:" + fileStore.getFullPath(storeFileName));

        log.info("uploadFileName={}", uploadFileName);

        String encodedUploadFileName = UriUtils.encode(uploadFileName, StandardCharsets.UTF_8);
        String contentDisposition = "attachment; filename=\"" + encodedUploadFileName + "\"";

        return ResponseEntity.ok()
                .header(HttpHeaders.CONTENT_DISPOSITION,contentDisposition)
                .body(resource);

    }
}
```


```html
<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
</head>
<body>
<div class="container">
    <div class="py-5 text-center">
        <h2>상품 등록</h2>
    </div>
    <form th:action method="post" enctype="multipart/form-data">
        <ul>
            <li>상품명 <input type="text" name="itemName"></li>
            <li>첨부파일<input type="file" name="attachFile" ></li>
            <li>이미지 파일들<input type="file" multiple="multiple" name="imageFiles" ></li>
        </ul>
        <input type="submit"/>
    </form>
</div> <!-- /container -->
</body>
</html>
```

```html
<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
</head>
<body>
<div class="container">
    <div class="py-5 text-center">
        <h2>상품 조회</h2>
    </div>
    상품명: <span th:text="${item.itemName}">상품명</span><br/>
    첨부파일: <a th:if="${item.attachFile}" th:href="|/attach/${item.id}|" th:text="${item.getAttachFile().getUploadFileName()}" /><br/>
    <img th:each="imageFile : ${item.imageFiles}" th:src="|/images/${imageFile.getStoreFileName()}|" width="300" height="300"/>
</div> <!-- /container -->
</body>
</html>
```


